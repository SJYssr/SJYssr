name: Update README

on:
  schedule:
    - cron: '0 * * * *'  # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡
  push:
    paths:
      - 'README.md'
      - '.github/workflows/main-readme.yml'
      - '.github/generate-stats.py'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  pull-requests: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´çš„æäº¤å†å²

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyGithub

      - name: Generate stats
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: python .github/generate-stats.py

      - name: Commit and push if changed
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "ğŸ“Š Update commit statistics"
          branch: main
          file_pattern: README.md

  generate-stats:
    name: Generate Commit Statistics
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyGithub python-dateutil

      - name: Generate commit statistics
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python .github/generate-stats.py

      - name: Commit and push if changed
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update commit statistics" && git push)

  generate:
    name: Generate Snake and Stats
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      # ç”Ÿæˆè›‡å½¢åŠ¨ç”»
      - name: generate snake.svg
        uses: Platane/snk/svg-only@v3
        with:
          github_user_name: ${{ github.repository_owner }}
          outputs: |
            dist/github-contribution-grid-snake.svg
            dist/github-contribution-grid-snake-dark.svg?palette=github-dark

      # æ¨é€è›‡å½¢åŠ¨ç”»åˆ°è¾“å‡ºåˆ†æ”¯
      - name: push snake.svg to the output branch
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: output
          build_dir: dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  verify:
    name: éªŒè¯æäº¤ç­¾å
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•
      
      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"
          
      - name: å®‰è£…ä¾èµ–é¡¹
        run: |
          python -m pip install --upgrade pip
          pip install requests pygithub
          
      - name: è°ƒè¯•ä¿¡æ¯
        run: |
          echo "Repository: ${{ github.repository }}"
          echo "Repository Owner: ${{ github.repository_owner }}"
          echo "Event Name: ${{ github.event_name }}"
          
      - name: è¿è¡ŒéªŒè¯è„šæœ¬
        env:
          GH_USER: ${{ github.repository_owner }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 signature-verifier.py || echo "éªŒè¯è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œä½†å·¥ä½œæµç»§ç»­è¿è¡Œ"
        continue-on-error: true  # å³ä½¿éªŒè¯å¤±è´¥ä¹Ÿç»§ç»­æ‰§è¡Œ

  rerun-failed-jobs:
    name: é‡è¯•å¤±è´¥çš„ä»»åŠ¡
    runs-on: ubuntu-latest
    needs: [generate, verify, generate-stats]
    if: failure()
    steps:
      - name: æ£€æŸ¥å¤±è´¥åŸå› 
        run: |
          echo "å·¥ä½œæµå¤±è´¥ï¼Œæ£€æŸ¥æ—¥å¿—ä»¥è·å–è¯¦ç»†ä¿¡æ¯"
          echo "å¤±è´¥çš„å·¥ä½œæµID: ${{ github.run_id }}"
          
      - name: é‡æ–°è¿è¡Œå¤±è´¥çš„å·¥ä½œæµ
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh run rerun ${{ github.run_id }} --failed || echo "é‡è¯•å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥"
        continue-on-error: true  # å³ä½¿é‡è¯•å¤±è´¥ä¹Ÿç»§ç»­æ‰§è¡Œ